name: CI - Enterprise Mode

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-enterprise-repositories-file:
    name: Test with Enterprise Repositories File
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SBT with Enterprise Repositories
        id: setup-sbt
        uses: tina-alliche/sbt-actions/.github/actions/setup-sbt@main
        with:
          sbt-version: '1.10.4'
          scala-version: '3.3.1'
          java-version: '21'
          repositories-file: 'test-configs/repositories-enterprise-test'
          enable-cache: true

      - name: Verify Repositories Configuration
        run: |
          echo "=== Checking Enterprise Repositories Configuration ==="
          if [ -f ~/.sbt/repositories ]; then
            echo "✓ Repositories file exists"
            echo ""
            echo "Content:"
            cat ~/.sbt/repositories
            echo ""
            echo "✓ Enterprise repositories configured"
          else
            echo "✗ Repositories file not found!"
            exit 1
          fi

      - name: Compile with Enterprise Repositories
        run: |
          echo "=== Compiling with Enterprise Repositories ==="
          sbt compile
          echo "✓ Compilation successful"

      - name: Run Tests with Enterprise Repositories
        run: |
          echo "=== Running Tests with Enterprise Repositories ==="
          sbt test
          echo "✓ All tests passed"

      - name: Verify Dependency Resolution
        run: |
          echo "=== Verifying Dependency Resolution ==="
          sbt "show libraryDependencies"
          echo "✓ Dependencies resolved correctly"

      - name: Display Setup Summary
        run: |
          echo "=== Enterprise Setup Summary ==="
          echo "SBT Version: ${{ steps.setup-sbt.outputs.sbt-version }}"
          echo "SBT Path: ${{ steps.setup-sbt.outputs.sbt-path }}"
          echo "Cache Hit: ${{ steps.setup-sbt.outputs.cache-hit }}"
          echo "Repositories: Custom enterprise configuration"
          echo "✓ Enterprise mode validated"

  test-enterprise-inline-config:
    name: Test with Inline Enterprise Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SBT with Inline Enterprise Config
        uses: tina-alliche/sbt-actions/.github/actions/setup-sbt@main
        with:
          sbt-version: '1.10.4'
          scala-version: '3.3.1'
          java-version: '21'
          repositories-content: |
            [repositories]
            local
            maven-central: https://repo1.maven.org/maven2/
            typesafe: https://repo.typesafe.com/typesafe/releases/
            sonatype: https://oss.sonatype.org/content/repositories/releases/
          enable-cache: true

      - name: Verify Inline Configuration
        run: |
          echo "=== Checking Inline Repositories Configuration ==="
          if [ -f ~/.sbt/repositories ]; then
            echo "✓ Repositories file exists"
            echo ""
            echo "Content:"
            cat ~/.sbt/repositories
          else
            echo "✗ Repositories file not found!"
            exit 1
          fi

      - name: Compile and Test with Inline Config
        run: |
          echo "=== Testing with Inline Configuration ==="
          sbt clean compile test
          echo "✓ Inline enterprise configuration working"

  test-enterprise-with-credentials:
    name: Test Enterprise Setup with Credentials Simulation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SBT with Enterprise Config and Mock Credentials
        uses: tina-alliche/sbt-actions/.github/actions/setup-sbt@main
        with:
          sbt-version: '1.10.4'
          scala-version: '3.3.1'
          java-version: '21'
          repositories-file: 'test-configs/repositories-enterprise-test'
          credentials-host: 'artifacts.example.com'
          credentials-realm: 'Artifactory Realm'
          enable-cache: true
        env:
          # Mock credentials (won't be used for actual auth with public repos)
          ARTIFACTORY_USER: 'test-user'
          ARTIFACTORY_API_KEY: 'test-api-key'

      - name: Verify Credentials Files Created
        run: |
          echo "=== Checking Credentials Configuration ==="
          
          if [ -f ~/.ivy2/.credentials ]; then
            echo "✓ Ivy2 credentials file exists"
            echo "Content (masked):"
            cat ~/.ivy2/.credentials | sed 's/password=.*/password=***MASKED***/'
          else
            echo "⚠ Ivy2 credentials file not found (may not be needed for public repos)"
          fi
          
          echo ""
          
          if [ -f ~/.sbt/1.0/plugins/credentials.sbt ]; then
            echo "✓ SBT credentials file exists"
          else
            echo "⚠ SBT credentials file not found (may not be needed for public repos)"
          fi

      - name: Compile and Test
        run: |
          echo "=== Testing with Enterprise Credentials Setup ==="
          sbt clean compile test
          echo "✓ Build successful with credentials configuration"
